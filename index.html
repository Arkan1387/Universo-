<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nexus Codex V2.3 | Definitive + Gemini</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { background-color: #0b1120; color: #cbd5e1; font-family: 'Inter', sans-serif; overflow-x: hidden; }
        .page-content { display: none; }
        .page-content.active { display: block; animation: fadeIn 0.2s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .nav-button.active { color: #38bdf8; border-bottom: 2px solid #38bdf8; background: #1e293b; }
        .sub-nav-button { font-size: 10px; padding: 6px 12px; border-radius: 4px; background: #1e293b; flex-shrink: 0; border: 1px solid #1e293b; }
        .sub-nav-button.active { background: #38bdf8; color: #0b1120; font-weight: bold; border-color: #38bdf8; }
        .sub-content { display: none; margin-top: 15px; }
        .sub-content.active { display: block; }
        .entry-card { background: #0f172a; border: 1px solid #1e293b; padding: 15px; border-radius: 12px; margin-bottom: 25px; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.4); }
        .node-img { width: 100%; max-height: 250px; object-fit: cover; border-radius: 8px; margin-bottom: 12px; border: 1px solid #334155; }
        .main-img { width: 100%; border-radius: 12px; margin-bottom: 15px; border: 1px solid #38bdf8; display: none; max-height: 300px; object-fit: cover; }
        textarea { background: #161e2e; border: 1px solid #1e293b; width: 100%; padding: 12px; border-radius: 8px; outline: none; font-size: 14px; color: #cbd5e1; line-height: 1.6; }
        textarea:focus { border-color: #38bdf8; }
        ::-webkit-scrollbar { display: none; }
    </style>
</head>
<body class="flex flex-col min-h-screen">

    <header class="bg-slate-900 p-4 border-b border-slate-800 flex justify-between items-center sticky top-0 z-50">
        <h1 class="font-black text-white uppercase text-xs tracking-widest italic">Protocolo Œ© V2.3</h1>
        <div class="flex gap-2">
            <button onclick="copyAndGo('https://chatgpt.com')" class="bg-indigo-600 text-[9px] px-2 py-1 rounded font-bold text-white uppercase italic">GPT</button>
            <button onclick="copyAndGo('https://gemini.google.com')" class="bg-blue-500 text-[9px] px-2 py-1 rounded font-bold text-white uppercase italic">Gemini</button>
            <button onclick="exportData()" class="bg-slate-700 text-[10px] px-2 py-1 rounded font-bold text-white">üíæ</button>
        </div>
    </header>

    <nav id="main-nav" class="bg-slate-900 border-b border-slate-800 sticky top-[53px] z-40 overflow-x-auto flex flex-nowrap"></nav>

    <main class="flex-1 p-5 pb-24" id="content-container"></main>

    <script>
        const PREFIX = 'v11_';
        const SCHEMA = [
            { id: 'inicio', title: 'üè†Inicio', subs: [] },
            { id: 'mundo', title: 'üåêSistema de Mundo', subs: ['Jerarquias', 'Megaplaneta Œ©', 'Leyes del Nyra y Alma', 'Habilidades Nyricas', 'Dimensiones', 'Planetas Eje', 'Sistemas', 'Reino Divino', 'Deseos'] },
            { id: 'crono', title: '‚åõCronolog√≠a', subs: ['Pasado', 'Hitos Actuales', 'Importantes'] },
            { id: 'notas', title: 'üìòNotas', subs: ['Ideas', 'Lluvia de Ideas', 'Dudas'] },
            { id: 'geo', title: 'üó∫Ô∏èGeograf√≠a', subs: ['Mapas/Clima', 'Ciudades', 'Continentes'] },
            { id: 'caps', title: 'üì∞Cap√≠tulos', subs: ['Estructura', 'Res√∫menes', 'Progreso'] },
            { id: 'escena', title: 'üìÑEscena Actual', subs: ['Borrador', 'Di√°logos', 'Revisiones'] },
            { id: 'arte', title: '‚öîÔ∏èArtefactos', subs: ['M√°gicos', 'Tecnol√≥gicos', 'Divinos'] },
            { id: 'bestia', title: 'üê≤Animales / Monstruos', subs: ['Depredadores', 'Dom√©sticos', 'M√≠ticos'] }
        ];

        let db_entries = JSON.parse(localStorage.getItem(PREFIX + 'entries')) || {};

        function init() {
            const nav = document.getElementById('main-nav');
            const container = document.getElementById('content-container');
            
            SCHEMA.forEach((sec, idx) => {
                nav.innerHTML += `<button onclick="openTab('${sec.id}')" id="btn-${sec.id}" class="nav-button ${idx===0?'active':''} px-4 py-3 text-[10px] font-bold uppercase flex-shrink-0">${sec.title}</button>`;

                let subHtml = '';
                if (sec.subs.length > 0) {
                    subHtml = `<div class="flex gap-2 mb-4 overflow-x-auto pb-2">`;
                    sec.subs.forEach((sub, sIdx) => {
                        subHtml += `<button onclick="openSub('${sec.id}', ${sIdx})" id="sub-btn-${sec.id}-${sIdx}" class="sub-nav-button ${sIdx===0?'active':''}">${sub}</button>`;
                    });
                    subHtml += `</div>`;
                    
                    sec.subs.forEach((sub, sIdx) => {
                        subHtml += `
                            <div id="sub-cont-${sec.id}-${sIdx}" class="sub-content ${sIdx===0?'active':''}">
                                <button onclick="addEntry('${sec.id}', ${sIdx})" class="w-full bg-sky-600/20 text-sky-400 text-[10px] py-3 rounded mb-6 font-bold border border-sky-600/30 uppercase tracking-widest">+ Agregar Nodo en ${sub}</button>
                                <div id="entries-${sec.id}-${sIdx}"></div>
                            </div>`;
                    });
                } else {
                    subHtml = `<textarea id="data-${sec.id}" oninput="saveRaw('${sec.id}')" class="h-96" placeholder="Escribe aqu√≠ la premisa o el resumen general de tu universo..."></textarea>`;
                }

                container.innerHTML += `
                    <div id="${sec.id}" class="page-content ${idx===0?'active':''}">
                        <h2 class="text-xl font-black text-white mb-4 uppercase italic tracking-tighter">${sec.title}</h2>
                        
                        <div class="mb-8 p-4 bg-slate-900/50 rounded-xl border border-slate-800">
                            <p class="text-[9px] text-slate-500 uppercase font-bold mb-3 italic">üñºÔ∏è Ilustraci√≥n General del Apartado</p>
                            <img id="main-img-${sec.id}" class="main-img">
                            <input type="file" accept="image/*" onchange="uploadMainImg(this, '${sec.id}')" class="text-[10px] text-slate-500">
                        </div>

                        ${subHtml}
                    </div>`;
            });
            loadAll();
        }

        function openTab(id) {
            document.querySelectorAll('.page-content').forEach(p => p.classList.remove('active'));
            document.querySelectorAll('.nav-button').forEach(b => b.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            document.getElementById('btn-' + id).classList.add('active');
            
            const section = SCHEMA.find(s => s.id === id);
            if(section && section.subs.length > 0) {
                openSub(id, 0);
            }
        }

        function openSub(secId, subIdx) {
            document.querySelectorAll(`#${secId} .sub-content`).forEach(c => c.classList.remove('active'));
            document.querySelectorAll(`#${secId} .sub-nav-button`).forEach(b => b.classList.remove('active'));
            const content = document.getElementById(`sub-cont-${secId}-${subIdx}`);
            const button = document.getElementById(`sub-btn-${secId}-${subIdx}`);
            if(content) content.classList.add('active');
            if(button) button.classList.add('active');
            renderEntries(secId, subIdx);
        }

        function uploadMainImg(input, secId) {
            const reader = new FileReader();
            reader.onload = e => {
                localStorage.setItem(PREFIX + 'mainimg_' + secId, e.target.result);
                const img = document.getElementById('main-img-' + secId);
                img.src = e.target.result; img.style.display = 'block';
            };
            reader.readAsDataURL(input.files[0]);
        }

        function addEntry(secId, subIdx) {
            const key = `${secId}-${subIdx}`;
            if(!db_entries[key]) db_entries[key] = [];
            db_entries[key].unshift({ id: Date.now(), title: '', text: '', links: '', img: '' });
            saveDB();
            renderEntries(secId, subIdx);
        }

        function renderEntries(secId, subIdx) {
            const key = `${secId}-${subIdx}`;
            const target = document.getElementById(`entries-${key}`);
            if(!target) return;
            target.innerHTML = '';
            
            (db_entries[key] || []).forEach(entry => {
                target.innerHTML += `
                    <div class="entry-card">
                        <img id="node-view-${entry.id}" src="${entry.img || ''}" class="node-img" style="display: ${entry.img ? 'block' : 'none'}">
                        
                        <div class="flex justify-between items-center mb-4">
                            <input type="text" oninput="updateEntry('${key}', ${entry.id}, 'title', this.value)" value="${entry.title}" placeholder="Nombre del Nodo..." class="bg-transparent text-lg font-bold text-white outline-none w-full border-b border-slate-800 focus:border-sky-500 pb-1 italic uppercase tracking-tighter">
                        </div>

                        <div class="flex gap-4 mb-4">
                            <label class="bg-slate-800 px-4 py-2 rounded text-[9px] font-bold cursor-pointer hover:bg-slate-700 transition flex-1 text-center">
                                üñºÔ∏è IMAGEN NODO
                                <input type="file" accept="image/*" onchange="uploadNodeImg(this, '${key}', ${entry.id})" class="hidden">
                            </label>
                            <button onclick="deleteEntry('${key}', ${entry.id}, '${secId}', ${subIdx})" class="text-red-900 text-[9px] font-bold uppercase px-2">Borrar</button>
                        </div>

                        <textarea oninput="updateEntry('${key}', ${entry.id}, 'text', this.value)" class="min-h-[160px] mb-4" placeholder="Escribe el conocimiento aqu√≠...">${entry.text}</textarea>
                        
                        <div class="bg-black/30 p-2 rounded border border-slate-800">
                             <p class="text-[8px] text-slate-500 uppercase font-bold mb-1 italic">Conexiones Mentales</p>
                             <input type="text" oninput="updateEntry('${key}', ${entry.id}, 'links', this.value)" value="${entry.links}" placeholder="Ej: Arkan, Ciudad de Œ©, Reliquia..." class="bg-transparent text-[10px] text-sky-400 outline-none w-full italic">
                        </div>
                    </div>`;
            });
        }

        function uploadNodeImg(input, key, entryId) {
            const reader = new FileReader();
            reader.onload = e => {
                const entry = db_entries[key].find(e => e.id === entryId);
                entry.img = e.target.result;
                saveDB();
                renderEntries(key.split('-')[0], parseInt(key.split('-')[1]));
            };
            reader.readAsDataURL(input.files[0]);
        }

        function updateEntry(key, entryId, field, val) {
            const entry = db_entries[key].find(e => e.id === entryId);
            if(entry) { entry[field] = val; saveDB(); }
        }

        function deleteEntry(key, entryId, secId, subIdx) {
            if(confirm('¬øEliminar nodo?')) {
                db_entries[key] = db_entries[key].filter(e => e.id !== entryId);
                saveDB();
                renderEntries(secId, subIdx);
            }
        }

        function saveRaw(id) { localStorage.setItem(PREFIX + 'raw_' + id, document.getElementById('data-' + id).value); }
        function saveDB() { localStorage.setItem(PREFIX + 'entries', JSON.stringify(db_entries)); }

        function loadAll() {
            SCHEMA.forEach(sec => {
                const mainImg = localStorage.getItem(PREFIX + 'mainimg_' + sec.id);
                if(mainImg) { const el = document.getElementById('main-img-' + sec.id); el.src = mainImg; el.style.display = 'block'; }
                
                if(sec.id === 'inicio') {
                    const val = localStorage.getItem(PREFIX + 'raw_inicio');
                    if(val) document.getElementById('data-inicio').value = val;
                }
            });
        }

        function copyAndGo(url) {
            const context = document.getElementById('data-inicio').value;
            navigator.clipboard.writeText(context).then(() => {
                alert("Contexto de INICIO copiado.");
                window.open(url, "_blank");
            });
        }

        function exportData() {
            const data = { entries: db_entries, raw: localStorage };
            const a = document.createElement('a');
            a.href = URL.createObjectURL(new Blob([JSON.stringify(data)], {type: 'application/json'}));
            a.download = 'MASTER_CODEX_ULTIMATE.json'; a.click();
        }

        window.onload = init;
    </script>
</body>
</html>